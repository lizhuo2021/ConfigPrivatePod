# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

desc 'Release new pod version'
lane :release_pod do |options|
  # è¾“å…¥repo name
  target_repo    = options[:repo]
  # è¾“å…¥spec name
  target_project = options[:specName]
  # è¾“å…¥ç‰ˆæœ¬å· tag
  target_version = options[:tag]
  # è¾“å…¥æè¿°
  target_desc    = options[:desc]

  spec_path      = "#{target_project}.podspec"

  if target_project.nil? || target_project.empty? || target_version.nil? || target_version.empty?
    UI.message("âŒ Project name and version number are required parameters")
    exit
  end

  UI.message("ğŸ‘‰ Start release lib #{target_project} new version #{target_version}")
  # è¡Œä¸º 
  # git pull
  # git_pull
  # å¦‚æœä¸åœ¨ç‰¹å®šçš„gitåˆ†æ”¯ä¸Šå¼•å‘å¼‚å¸¸
  # ensure_git_branch

  # 2ã€pod install
  cocoapods(
	clean: true,
	podfile: "./Podfile"
  )

  # åœ¨podspecæ–‡ä»¶ä¸­å¢åŠ æˆ–è®¾ç½®ç‰ˆæœ¬
  version_bump_podspec(path: spec_path, version_number: target_version)
  # git add
  git_add(path: '.')
  begin
    if target_desc.nil? || target_desc.empty?
      git_commit(path: '.', message: "release #{target_version}")
    else
      git_commit(path: '.', message: target_desc)
    end
  rescue
    error_message = "#{$!}"
    UI.message("âš ï¸ commit error:#{error_message}")
    unless error_message.include?("nothing to commit, working directory clean")
      exit
    end
    UI.message("The local code has committed, skip the commit step!")
  end
  # git push origin master
  push_to_git_remote
  if git_tag_exists(tag: target_version)
      UI.message("Tag #{target_version} already exists, then, delete it! ğŸ’¥")
      remove_git_tag(tag: target_version)
  end
  # git add tag 
  add_git_tag(tag: target_version)

  # å°†æœ¬åœ°æ ‡ç­¾æ¨é€åˆ°è¿œç¨‹ - è¿™åªä¼šæ¨é€æ ‡ç­¾
  push_git_tags
  # æ£€æŸ¥
  pod_lib_lint(allow_warnings: true)

  if target_repo
    pod_push(path: spec_path, repo: target_repo, allow_warnings: true)
    UI.message("Release lib #{target_project} new version #{target_version} to repo #{target_repo} Successfully! ğŸ‰ ")
  else
    pod_push(path: spec_path, allow_warnings: true)
    UI.message("Release lib #{target_project} new version #{target_version} to CocoaPods/Specs Successfully! ğŸ‰ ")
  end
end